# Copyright 2023 Google LLC All Rights Reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
steps:
- name: 'ubuntu'
  args: [
    'echo',
    'Building image ${_ARTIFACT_REPO_REGION}-docker.pkg.dev/$_GCP_PROJECT_ID/${_ARTIFACT_REPO_NAME}/${_IMAGE_NAME}'
  ]
- name: 'gcr.io/cloud-builders/docker'
  args: [
    'build',
    '-t',
    '${_ARTIFACT_REPO_REGION}-docker.pkg.dev/$_GCP_PROJECT_ID/${_ARTIFACT_REPO_NAME}/${_IMAGE_NAME}',
    '--build-arg',
    'GCS_MODEL_PATH=${_GCS_MODEL_PATH}',
    '.'
  ]
- name: 'gcr.io/cloud-builders/docker'
  args: [
    'push',
    '${_ARTIFACT_REPO_REGION}-docker.pkg.dev/$_GCP_PROJECT_ID/${_ARTIFACT_REPO_NAME}/${_IMAGE_NAME}'
  ]
- name: 'gcr.io/cloud-builders/gcloud'
  args: [
    'ai',
    'custom-jobs',
    'create',
    '--region=${_VERTEX_AI_TRAINING_REGION}',
    '--display-name=${_VERTEX_AI_TRAINING_JOB_NAME}',
    '--worker-pool-spec=machine-type=${_VERTEX_AI_TRAINING_MACHINE_TYPE},replica-count=${_VERTEX_AI_TRAINING_REPLICA_COUNT},container-image-uri=${_ARTIFACT_REPO_REGION}-docker.pkg.dev/$_GCP_PROJECT_ID/${_ARTIFACT_REPO_NAME}/${_IMAGE_NAME}'
  ]
substitutions:
  _GCP_PROJECT_ID: "default"
  _ARTIFACT_REPO_REGION: "default"
  _ARTIFACT_REPO_NAME: "default"
  _IMAGE_NAME: "default"
  _GCS_MODEL_PATH: "default"
  _VERTEX_AI_TRAINING_REGION: "default"
  _VERTEX_AI_TRAINING_JOB_NAME: "default"
  _VERTEX_AI_TRAINING_MACHINE_TYPE: "default"
  _VERTEX_AI_TRAINING_REPLICA_COUNT: "1" # default
images:
- '${_ARTIFACT_REPO_REGION}-docker.pkg.dev/$_GCP_PROJECT_ID/${_ARTIFACT_REPO_NAME}/${_IMAGE_NAME}'
