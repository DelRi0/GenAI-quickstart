# Copyright 2023 Google LLC All Rights Reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
steps:
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    args: ['gsutil', 'cp', '-r', '${_GCS_MODEL_PATH}', '.']
  - name: bash
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        mkdir model_version && mkdir model_version/000001 && mv ./${_MODEL_NAME}/* model_version/000001
  - name: 'gcr.io/cloud-builders/docker'
    args: [
      'build',
      '--build-arg',
      'MODEL_NAME=${_MODEL_NAME}',
      '-t',
      '${_ARTIFACT_REPO_REGION}-docker.pkg.dev/${_GCP_PROJECT_ID}/${_ARTIFACT_REPO_NAME}/${_IMAGE_NAME}',
      '.'
    ]
substitutions:
  _GCP_PROJECT_ID: mygcpproject # default
  _ARTIFACT_REPO_REGION: us-central1 # default
  _ARTIFACT_REPO_NAME: udp-repo # default
  _IMAGE_NAME: myimage # default
  _MODEL_NAME: modelname # default
  _GCS_MODEL_PATH: 'gs://gcs_bucket_name/path/to/mymodel_directory' # default
images:
- '${_ARTIFACT_REPO_REGION}-docker.pkg.dev/${_GCP_PROJECT_ID}/${_ARTIFACT_REPO_NAME}/${_IMAGE_NAME}'
